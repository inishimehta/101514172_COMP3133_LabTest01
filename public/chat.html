<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>VibeChat | Chat</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/app.css">
  </head>

  <body>
    <div class="app-shell">
      <div class="app-card">
        <div class="app-bar d-flex align-items-center justify-content-between">
          <div id="title">VibeChat</div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-light" id="leave">Leave Room</button>
            <button class="btn btn-sm btn-outline-light" id="logout">Logout</button>
          </div>
        </div>

        <div class="app-body">
          <div class="chat-grid">
            <div class="panel">
              <div class="panel-h">Room</div>
              <div class="panel-b">
                <div class="small-muted mb-3" id="roomName"></div>

                <div class="fw-bold mb-2">Active members</div>
                <div id="members">
                  <div class="small-muted">Loading...</div>
                </div>

                <div class="small-muted mt-3">
                  ðŸ’¡ Tip: Open another browser/tab with a different user to test typing + DM.
                </div>
              </div>
            </div>

            <div class="panel d-flex flex-column">
              <div class="panel-h pb-0">
                <ul class="nav nav-tabs" role="tablist">
                  <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#roomPane" type="button" role="tab">
                      Room chat
                    </button>
                  </li>
                  <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#dmPane" type="button" role="tab">
                      Direct message
                    </button>
                  </li>
                </ul>
              </div>

              <div class="tab-content flex-grow-1">
                <div class="tab-pane fade show active h-100" id="roomPane" role="tabpanel">
                  <div id="messages" class="panel-b scroll"></div>
                  <div id="typing" class="small-muted px-3 pb-2"></div>

                  <div class="panel-b pt-0">
                    <div class="input-group">
                      <input class="form-control" id="msg" placeholder="Type message..." />
                      <button class="btn btn-primary" id="send">Send</button>
                    </div>
                  </div>
                </div>

                <div class="tab-pane fade h-100" id="dmPane" role="tabpanel">
                  <div class="panel-b">
                    <label class="form-label mb-1">Send to</label>
                    <select class="form-select" id="dmUser"></select>

                    <div id="dmTyping" class="small-muted mt-2"></div>

                    <div id="dmBox" class="scroll mt-3" style="min-height:260px;"></div>

                    <div class="input-group mt-3">
                      <input class="form-control" id="dmMsg" placeholder="Type private message..." />
                      <button class="btn btn-primary" id="dmSend">Send DM</button>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>

      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const username = localStorage.getItem("username");
      const room = localStorage.getItem("room");

      if (!username) window.location = "/login.html";
      if (!room) window.location = "/rooms.html";

      document.getElementById("title").innerText = `VibeChat â€¢ ${room} â€¢ ${username}`;
      document.getElementById("roomName").innerText = room;

      function fmtTime(d) {
        return new Date(d).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
      }

      function addGroupMsg({ from, message, date_sent }) {
        const wrap = document.createElement("div");
        wrap.className = "msg";

        const head = document.createElement("div");
        head.className = "msg-h";
        head.innerHTML = `<span>${from}</span><span>${fmtTime(date_sent || Date.now())}</span>`;

        const bubble = document.createElement("div");
        bubble.className = "bubble" + (from === username ? " me" : "");
        bubble.innerText = message;

        wrap.appendChild(head);
        wrap.appendChild(bubble);

        const box = document.getElementById("messages");
        box.appendChild(wrap);
        box.scrollTop = box.scrollHeight;
      }

      function addSystemMsg(text) {
        const wrap = document.createElement("div");
        wrap.className = "msg";

        const head = document.createElement("div");
        head.className = "msg-h";
        head.innerHTML = `<span>System</span><span>${fmtTime(Date.now())}</span>`;

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.innerText = text;

        wrap.appendChild(head);
        wrap.appendChild(bubble);

        const box = document.getElementById("messages");
        box.appendChild(wrap);
        box.scrollTop = box.scrollHeight;
      }

      function addDmMsg(p) {
        const wrap = document.createElement("div");
        wrap.className = "msg";

        const head = document.createElement("div");
        head.className = "msg-h";
        head.innerHTML = `<span>${p.from_user} â†’ ${p.to_user}</span><span>${fmtTime(p.date_sent || Date.now())}</span>`;

        const bubble = document.createElement("div");
        bubble.className = "bubble" + (p.from_user === username ? " me" : "");
        bubble.innerText = p.message;

        wrap.appendChild(head);
        wrap.appendChild(bubble);

        const box = document.getElementById("dmBox");
        box.appendChild(wrap);
        box.scrollTop = box.scrollHeight;
      }

      // connect
      socket.emit("registerUser", { username });
      socket.emit("joinRoom", { room, username });

      // DM dropdown users + AUTO load history (important)
      socket.on("onlineUsers", (users) => {
        const sel = document.getElementById("dmUser");
        const current = sel.value;
        sel.innerHTML = "";

        users.filter((u) => u !== username).forEach((u) => {
          const opt = document.createElement("option");
          opt.value = u;
          opt.innerText = u;
          sel.appendChild(opt);
        });

        if (current) sel.value = current;

        const userB = sel.value;
        if (userB) socket.emit("getDMHistory", { userA: username, userB });
      });

      // Room members list
      socket.on("roomMembers", (members) => {
        const box = document.getElementById("members");
        box.innerHTML = "";
        if (!members.length) {
          box.innerHTML = `<div class="small-muted">No members</div>`;
          return;
        }
        members.forEach((m) => {
          const div = document.createElement("div");
          div.className = "member";
          div.innerText = m;
          box.appendChild(div);
        });
      });

      // group history + messages
      socket.on("roomHistory", (msgs) => {
        const box = document.getElementById("messages");
        box.innerHTML = "";
        msgs.forEach((m) => addGroupMsg({ from: m.from_user, message: m.message, date_sent: m.date_sent }));
      });

      socket.on("system", (text) => addSystemMsg(text));

      socket.on("groupMessage", (payload) => {
        addGroupMsg({ from: payload.from, message: payload.message, date_sent: payload.date_sent });
      });

      // ROOM typing
      const typingDiv = document.getElementById("typing");
      const msgInput = document.getElementById("msg");
      let typingTimeout;

      function emitStopTyping() {
        socket.emit("stopTyping", { room, username });
      }

      msgInput.addEventListener("input", () => {
        const val = msgInput.value.trim();
        if (!val) {
          clearTimeout(typingTimeout);
          emitStopTyping();
          return;
        }
        socket.emit("typing", { room, username });
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => emitStopTyping(), 1500);
      });

      socket.on("typing", ({ username }) => (typingDiv.innerText = `${username} is typing...`));
      socket.on("stopTyping", () => (typingDiv.innerText = ""));

      document.getElementById("send").onclick = () => {
        const message = msgInput.value.trim();
        if (!message) return;
        socket.emit("groupMessage", { room, from: username, message });
        msgInput.value = "";
        clearTimeout(typingTimeout);
        emitStopTyping();
      };

      // DM typing
      const dmTypingDiv = document.getElementById("dmTyping");
      const dmMsgInput = document.getElementById("dmMsg");
      let dmTypingTimeout;

      function dmEmitStopTyping() {
        const to_user = document.getElementById("dmUser").value;
        if (!to_user) return;
        socket.emit("dmStopTyping", { to_user, from_user: username });
      }

      dmMsgInput.addEventListener("input", () => {
        const to_user = document.getElementById("dmUser").value;
        const val = dmMsgInput.value.trim();
        if (!to_user) return;

        if (!val) {
          clearTimeout(dmTypingTimeout);
          dmEmitStopTyping();
          return;
        }

        socket.emit("dmTyping", { to_user, from_user: username });
        clearTimeout(dmTypingTimeout);
        dmTypingTimeout = setTimeout(() => dmEmitStopTyping(), 1500);
      });

      socket.on("dmTyping", ({ from_user }) => (dmTypingDiv.innerText = `${from_user} is typing...`));
      socket.on("dmStopTyping", () => (dmTypingDiv.innerText = ""));

      // DM history + change
      document.getElementById("dmUser").addEventListener("change", () => {
        const userB = document.getElementById("dmUser").value;
        if (userB) socket.emit("getDMHistory", { userA: username, userB });
      });

      socket.on("dmHistory", (msgs) => {
        const box = document.getElementById("dmBox");
        box.innerHTML = "";
        if (!msgs.length) {
          box.innerHTML = `<div class="small-muted">No messages yet.</div>`;
          return;
        }
        msgs.forEach(addDmMsg);
      });

      // send DM
      document.getElementById("dmSend").onclick = () => {
        const to_user = document.getElementById("dmUser").value;
        const message = dmMsgInput.value.trim();
        if (!to_user || !message) return;

        socket.emit("privateMessage", { to_user, from_user: username, message });
        dmMsgInput.value = "";
        clearTimeout(dmTypingTimeout);
        dmEmitStopTyping();
      };

      socket.on("privateMessage", (p) => addDmMsg(p));

      // leave/logout
      document.getElementById("leave").onclick = () => {
        clearTimeout(typingTimeout);
        emitStopTyping();
        clearTimeout(dmTypingTimeout);
        dmEmitStopTyping();

        socket.emit("leaveRoom", { room, username });
        localStorage.removeItem("room");
        window.location = "/rooms.html";
      };

      document.getElementById("logout").onclick = () => {
        clearTimeout(typingTimeout);
        emitStopTyping();
        clearTimeout(dmTypingTimeout);
        dmEmitStopTyping();

        socket.emit("leaveRoom", { room, username });
        localStorage.clear();
        window.location = "/login.html";
      };
    </script>
  </body>
</html>
