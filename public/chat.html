<!doctype html>
<html>
  <body>
    <h3 id="title">Chat</h3>
    <button id="leave">Leave Room</button>
    <button id="logout">Logout</button>

    <div id="messages"></div>
    <div id="typing"></div>

    <input id="msg" placeholder="Type message..." />
    <button id="send">Send</button>

    <hr />
    <h4>Private Message</h4>
    <select id="dmUser"></select>
    <input id="dmMsg" placeholder="Type private message..." />
    <button id="dmSend">Send DM</button>
    <div id="dmBox"></div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const username = localStorage.getItem("username");
      const room = localStorage.getItem("room");

      if (!username) window.location = "/login.html";
      if (!room) window.location = "/rooms.html";

      document.getElementById("title").innerText = `Room: ${room} | User: ${username}`;

      socket.emit("registerUser", { username });
      socket.emit("joinRoom", { room, username });

      socket.on("onlineUsers", (users) => {
        const sel = document.getElementById("dmUser");
        const current = sel.value;
        sel.innerHTML = "";

        users
          .filter((u) => u !== username)
          .forEach((u) => {
            const opt = document.createElement("option");
            opt.value = u;
            opt.innerText = u;
            sel.appendChild(opt);
          });

        if (current) sel.value = current;
      });

      socket.on("roomHistory", (msgs) => {
        const box = document.getElementById("messages");
        box.innerHTML = "";
        msgs.forEach((m) => {
          const div = document.createElement("div");
          div.innerText = `${m.from_user}: ${m.message}`;
          box.appendChild(div);
        });
      });

      socket.on("system", (text) => {
        const div = document.createElement("div");
        div.innerText = text;
        document.getElementById("messages").appendChild(div);
      });

      socket.on("groupMessage", (payload) => {
        const div = document.createElement("div");
        div.innerText = `${payload.from}: ${payload.message}`;
        document.getElementById("messages").appendChild(div);
      });

      const typingDiv = document.getElementById("typing");
      let typingTimeout;

      document.getElementById("msg").addEventListener("input", () => {
        socket.emit("typing", { room, username });

        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
          socket.emit("stopTyping", { room, username });
        }, 1500);
      });

      socket.on("typing", ({ username }) => {
        typingDiv.innerText = `${username} is typing...`;
      });

      socket.on("stopTyping", () => {
        typingDiv.innerText = "";
      });

      document.getElementById("send").onclick = () => {
        const message = document.getElementById("msg").value.trim();
        if (!message) return;
        socket.emit("groupMessage", { room, from: username, message });
        document.getElementById("msg").value = "";
        socket.emit("stopTyping", { room, username });
      };

      document.getElementById("dmSend").onclick = () => {
        const to_user = document.getElementById("dmUser").value;
        const message = document.getElementById("dmMsg").value.trim();
        if (!to_user || !message) return;

        socket.emit("privateMessage", { to_user, from_user: username, message });
        document.getElementById("dmMsg").value = "";
      };

      socket.on("privateMessage", (p) => {
        const div = document.createElement("div");
        div.innerText = `[DM] ${p.from_user} -> ${p.to_user}: ${p.message}`;
        document.getElementById("dmBox").appendChild(div);
      });

      document.getElementById("leave").onclick = () => {
        socket.emit("stopTyping", { room, username });
        socket.emit("leaveRoom", { room, username });
        localStorage.removeItem("room");
        window.location = "/rooms.html";
      };

      document.getElementById("logout").onclick = () => {
        socket.emit("stopTyping", { room, username });
        socket.emit("leaveRoom", { room, username });
        localStorage.clear();
        window.location = "/login.html";
      };
    </script>
  </body>
</html>
